name: Alert PR and Push to Dev/Main

on:
  pull_request:
    branches: [Dev, main]
  push:
    branches: [Dev, main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Discordì— Push, PR ì„±ê³µ/ì‹¤íŒ¨ ì•Œë¦¼ ë³´ë‚´ê¸°
        if: always()
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: |
            ğŸš¦ **ê¹ƒ ë ˆí¬ ë³€ê²½ ì‚¬í•­ ì•Œë¦¼**
            - í”„ë¡œì íŠ¸: ${{ github.repository }}
            - ë¸Œëœì¹˜: ${{ github.ref }}
            - ì´ë²¤íŠ¸ íƒ€ì…: ${{ github.event_name }}
            - ì»¤ë°‹: ${{ github.sha }}
            - ì»¤ë°‹ ì‘ì„±ì: ${{ github.actor }}
            - [ì›Œí¬í”Œë¡œìš° ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - ê²°ê³¼: **${{ job.status }}**

      - name: github Actions ë¬´ë£Œë¶„ ì‚¬ìš©ëŸ‰ ì²´í¬ ë° Discord ì•Œë¦¼
        if: always()
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          USAGE_API="https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/usage"
          API_RESULT=$(curl -s -H "Authorization: token $GH_TOKEN" "$USAGE_API")
          echo "$API_RESULT"

          USAGE=$(echo "$API_RESULT" | jq '[.billable[]?.minutes_used] | add')
          if [ -z "$USAGE" ] || [ "$USAGE" = "null" ]; then
            USAGE=0
          fi
          MAX=2000
          REMAIN=$((MAX-USAGE))
          PERCENT=$((USAGE*100/MAX))

          MSG="\
          :stopwatch: **GitHub Actions ë¬´ë£Œ ì‚¬ìš©ëŸ‰ í˜„í™©**\n\
          - í˜„ì¬ ì‚¬ìš©ëŸ‰: **${USAGE}ë¶„ / ${MAX}ë¶„** (${PERCENT}%)\n\
          - ë‚¨ì€ ë¬´ë£Œë¶„: **${REMAIN}ë¶„**\
          "
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"$MSG\"}" \
            $DISCORD_WEBHOOK