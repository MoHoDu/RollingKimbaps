## 25.07.15 재료 이미지 변경 및 서빙 버그 픽스

### 회고

- 임시로 만들어둔 재료 이미지를 대체할 이미지 리소스 업데이트 (직접 그림)
- 재료가 그냥 캐릭터 내에 배치되다보니 레시피에 맞는 조합이 이루어진 것인지 알기 힘듦
- 서빙 성공 시에도 특별한 상황에서 입력이 먹히는 경우가 존재함. 이 경우에 서빙 성공은 되지 않고 재료만 사라짐.

### 작업 목표

- 재료 이미지 배치 로직 수정 (캐릭터 및 오더 UI)
  - 현재 모은 재료의 레시피에 대한 프리셋이 있는 경우에만 프리셋 이미지를 세팅
- 서빙 버그 픽스

### 재료 이미지 변경 TODO 리스트

- [x] **IngredientsInKimbapUI에서 재료 세팅 시 레시피와 프리셋 확인**
  - DataContainer.RecipeDatas에서 재료 데이터 배열로 레시피를 가져올 수 있는 메서드 생성
- [x] **프리셋을 세팅하는 메서드 추가**
  - 레시피를 획득했을 때에 프리셋을 가져와 세팅하는 로직을 추가
  - 레시피 혹은 프리셋이 없는 경우 기존 로직으로 연결
- [x] **OrderUI 예외 처리**
  - 캔버스 구조인 OrderUI를 위해 \_presetImage, \_presetSpriteRenderer를 변수로 두고, null이 아닌 컴포넌트의 sprite에 접근
- [x] **통합 테스트**
  - 모든 기능의 통합 동작 테스트
  - 유저 경험 상 얼마나 더 나은지 판단

### 서빙 버그 픽스 TODO 리스트

#### 버그 원인 분석 (수정됨)

- **문제점**: 서빙 성공 상황에서도 OrderSystem이나 OrdersUI에서 성공 로직을 수행하지 않고 무시하는 현상이 종종 발생
- **영향**: 서빙이 성공해야 하는 상황에서도 UI 업데이트나 보상 지급 등이 제대로 처리되지 않아 사용자 경험 저하
- **핵심 파일**: `Assets/Scripts/InGame/CharacterHandler.cs`, `Assets/Scripts/ManagerSystem/InGame/CombinationManager.cs`, `Assets/Scripts/ManagerSystem/InGame/OrderSystem.cs`, `Assets/Scripts/UI/InGame/OrdersUI.cs`
- **중요 사항**: 재료 제거는 성공/실패 관계없이 항상 수행되어야 함 (기존 로직 유지)

#### 해결 태스크 계획 (수정됨)

- [x] **Task 1: 서빙 성공 처리 플로우 디버깅 로그 추가**
  - **ID**: `521bc57a-5a3a-46db-964d-0f9047ab4740`
  - 설명: 서빙 성공 시 각 단계별 처리 상태를 확인하기 위한 디버깅 로그를 추가
  - 완료 기준: CharacterHandler부터 OrderSystem, OrdersUI까지 전체 플로우 추적 가능
  - 우선순위: 높음
  - **상태**: ✅ **완료**

- [x] **Task 2: 서빙 성공 처리 누락 구간 식별 및 분석**
  - **ID**: `f61e2a8a-95a3-48a3-ad6c-7131953b89e5`
  - 설명: 디버깅 로그를 통해 서빙 성공 처리가 누락되는 정확한 구간을 식별
  - 완료 기준: 문제 발생 시점과 원인을 명확히 파악하고 문서화
  - 우선순위: 높음
  - **상태**: ✅ **완료**
  - **분석 결과**: `GetCurrentRecipe()` null 반환 문제 - 타이밍 및 상태 동기화 문제 확인

#### 분석 결과 (Task 2 완료)

**핵심 문제 식별**: `CombinationManager.OnTryServing()`에서 `GetCurrentRecipe()`를 호출했을 때 올바른 재료가 수집되어 있음에도 불구하고 `null`을 반환하는 현상

**원인 분석**:
1. **타이밍 문제**: 
   - `CharacterHandler.InputSubmitKey()` → `OnTryServing()` → `character.ClearIngredients()` 순서
   - 서빙 성공 시 `CombinationManager.ClearCollectedIngredients()` 호출 안함
   - 서빙 실패 시에만 `CombinationManager.ClearCollectedIngredients()` 호출

2. **상태 불일치 문제**:
   - UI 상태(`Character.ClearIngredients()`)와 내부 데이터 상태(`_collectedIngredientType`) 간 동기화 부족
   - 서빙 성공 시 UI는 지워지지만 내부 상태는 유지되어 다음 서빙에 영향

3. **추가 확인 필요 사항**:
   - 재료 수집 시점의 `_collectedIngredientType` 상태
   - 비트마스크 계산 및 레시피 매칭 과정
   - `Character.ClearIngredients()`와 `CombinationManager.ClearCollectedIngredients()` 호출 순서

#### 최종 해결 결과 (모든 태스크 완료)

**문제 해결 완료**: `GetCurrentRecipe()` null 반환 문제가 근본적으로 해결되었습니다.

**핵심 수정 사항**:
- `CombinationManager.OnTryServing()` 메서드에서 `ClearCollectedIngredients()` 호출 시점 조정
- **이전**: 서빙 실패 시에만 `ClearCollectedIngredients()` 호출
- **수정**: 서빙 성공/실패 관계없이 항상 마지막에 `ClearCollectedIngredients()` 호출

**수정된 코드 구조**:
```csharp
public void OnTryServing()
{
    RecipeData recipe = GetCurrentRecipe();
    if (recipe != null && Order.Serving(recipe))
    {
        // 서빙 성공 처리
        // 보상 지급, 이벤트 호출 등
    }
    else
    {
        // 서빙 실패 처리
        // 실패 이벤트 호출 등
    }
    
    // 성공/실패 관계없이 항상 재료 제거
    ClearCollectedIngredients();
}
```

**해결된 문제들**:
1. ✅ **상태 동기화 문제**: UI 상태와 내부 데이터 상태 일치
2. ✅ **타이밍 문제**: 재료 제거 시점 일관성 확보
3. ✅ **GetCurrentRecipe() null 반환**: 재료 상태 정합성 보장
4. ✅ **서빙 성공 처리 누락**: OrderSystem과 OrdersUI 정상 동작

**검증 결과**:
- 서빙 성공 시: 정상적인 보상 지급 및 UI 업데이트
- 서빙 실패 시: 정상적인 실패 처리 및 재료 제거
- 연속 서빙 시: 이전 상태 간섭 없는 정상 동작

- [x] **Task 3: 식별된 문제 구간 수정 방안 설계**
  - **ID**: `6b6c6cc4-fdb7-403e-a0da-4ddb8bc9dad0`
  - 설명: 분석 결과를 바탕으로 서빙 성공 처리 누락 문제 해결 방안 설계
  - 완료 기준: 구체적이고 실행 가능한 수정 방안 설계 완료
  - 우선순위: 높음
  - **상태**: ✅ **완료**
  - **설계 결과**: OnTryServing() 메서드에서 ClearCollectedIngredients() 호출 시점 조정

- [x] **Task 4: 서빙 성공 처리 로직 수정 구현**
  - **ID**: `3cde1c39-92a3-43b6-a7eb-99bbd4c31b06`
  - 설명: 설계된 수정 방안을 바탕으로 서빙 성공 처리 로직 수정 구현
  - 완료 기준: OrderSystem과 OrdersUI에서 성공 로직이 정상적으로 수행됨
  - 우선순위: 높음
  - **상태**: ✅ **완료**
  - **구현 내용**: ClearCollectedIngredients() 호출을 성공/실패 분기문 밖으로 이동

- [x] **Task 5: 수정된 서빙 시스템 통합 테스트**
  - **ID**: `429ffb6f-9fd7-4faf-813e-d1b1fde8eec4`
  - 설명: 수정된 서빙 시스템의 전체적인 동작을 테스트하여 문제 해결 확인
  - 완료 기준: 모든 서빙 시나리오에서 의도한 대로 동작 확인
  - 우선순위: 높음
  - **상태**: ✅ **완료**
  - **테스트 결과**: 모든 시나리오에서 정상 동작 확인

#### 기술적 세부사항 (수정됨)

**문제 상황**:
- 서빙 성공 시에도 OrderSystem이나 OrdersUI에서 성공 로직을 수행하지 않는 현상 발생
- 재료는 항상 제거되어야 하므로 현재 로직 유지 필요
- 문제 발생 시점과 원인을 먼저 파악하는 것이 중요

**디버깅 접근법**:
```csharp
// 각 단계별 디버깅 로그 추가 예시
public void InputSubmitKey()
{
    Debug.Log($"[SERVING] InputSubmitKey called at {Time.time}");
    if (_gameStatus is not EGameStatus.PLAY) return;
    if (_characterState == ECharacterState.NORMAL)
    {
        Debug.Log($"[SERVING] Attempting serving...");
        _combinationManager.OnTryServing();
        Debug.Log($"[SERVING] Clearing ingredients...");
        character.ClearIngredients();
    }
}
```

**예상 수정 방향**:
1. 전체 처리 플로우에 디버깅 로그 추가
2. 문제 발생 구간 식별 및 원인 분석
3. 식별된 문제에 대한 구체적인 수정 방안 설계
4. 재료 제거 로직은 유지하면서 성공 처리 로직 개선

#### 검증 기준 (수정됨)

- 서빙 성공 시: OrderSystem과 OrdersUI에서 성공 로직이 정상적으로 수행되고 재료가 제거됨
- 서빙 실패 시: 실패 이펙트가 표시되고 재료가 제거됨 (재료 제거는 성공/실패 관계없이 항상 수행)
- 디버깅 로그를 통해 문제 발생 시점을 정확히 파악할 수 있음
- 수정 후 모든 서빙 시나리오에서 의도한 대로 동작함
